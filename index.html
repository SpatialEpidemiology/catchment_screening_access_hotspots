<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catchments & Tracts Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- PMTiles JS -->
  <script src="https://unpkg.com/pmtiles@3.1.2/dist/pmtiles.js"></script>
  <!-- VectorGrid -->
  <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; }

    .control-panel {
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      border-radius: 4px;
      z-index: 1000;
    }

    .legend {
      position: absolute;
      bottom: 20px; right: 20px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      border-radius: 4px;
      z-index: 1000;
    }

    .legend .color-box {
      display: inline-block;
      width: 18px; height: 18px;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="control-panel">
    <strong>sc_acc_hot_spots_overlap_95.pmtiles</strong><br/>
    <label><input type="radio" name="tractField" value="COLON_SCRE_95" checked> COLON_SCRE</label><br/>
    <label><input type="radio" name="tractField" value="fin100k_95"> fin100k</label><br/>
    <label><input type="radio" name="tractField" value="overlap_type_95"> overlap_type</label>
    <hr/>
    <strong>sc_acc_hot_spots_overlap_99.pmtiles</strong><br/>
    <label><input type="radio" name="tractField" value="COLON_SCRE_99"> COLON_SCRE</label><br/>
    <label><input type="radio" name="tractField" value="fin100k_99"> fin100k</label><br/>
    <label><input type="radio" name="tractField" value="overlap_type_99"> overlap_type_99</label>
  </div>

  <div class="legend">
    <strong>Legend</strong>
    <div id="legend-content"></div>
  </div>

  <script>
    const map = L.map('map').setView([33.5186, -86.8104], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CartoDB'
    }).addTo(map);

    // Load catchments as border-only
    fetch('assets/catchments.json').then(r => r.json()).then(data => {
      L.geoJSON(data, {
        style: { color: '#FF7F00', weight: 2, fillOpacity: 0 },
        onEachFeature: (f, l) => f.properties?.name && l.bindPopup(f.properties.name)
      }).addTo(map);
    });

    const pm95 = new PMTiles('assets/sc_acc_hot_spots_overlap_95.pmtiles');
    const pm99 = new PMTiles('assets/sc_acc_hot_spots_overlap_99.pmtiles');
    let currentLayer;

    function getColor(field, v) {
      if (field === 'COLON_SCRE') {
        if (v > 80) return '#08306b';
        if (v > 60) return '#2171b5';
        if (v > 40) return '#4292c6';
        if (v > 20) return '#6baed6';
        return '#9ecae1';
      } 
      if (field === 'fin100k') {
        if (v > 120) return '#4b0055';
        if (v > 90) return '#7a3290';
        if (v > 60) return '#985ea7';
        if (v > 30) return '#b68bc1';
        return '#d5b6da';
      }
      if (field === 'overlap_type') {
        if (v === 'Low Screening-Low Access Cluster') return '#d73027';
        if (v === 'High Screening-High Access Cluster') return '#6baed6';
        if (v === 'Non-significant') return '#999999';
        return '#ccc';
      }
      return '#ccc';
    }

    function createLayer(pmtiles, field) {
      return L.vectorGrid.protobuf(pmtiles.getURLTemplate(), {
        vectorTileLayerStyles: {
          layer0: feat => {
            const val = feat.properties[field];
            return {
              fillColor: getColor(field, val),
              fillOpacity: 0.7,
              color: '#444',
              weight: 0.5
            };
          }
        },
        maxZoom: 14,
        minZoom: 4
      });
    }

    function updateLegend(fieldKey) {
      const lc = document.getElementById('legend-content');
      let html = '';
      const field = fieldKey.replace(/_\d+$/, '');
      if (field === 'COLON_SCRE') {
        html += '<div><span class="color-box" style="background:#08306b;"></span>>80%</div>';
        html += '<div><span class="color-box" style="background:#2171b5;"></span>61–80%</div>';
        html += '<div><span class="color-box" style="background:#4292c6;"></span>41–60%</div>';
        html += '<div><span class="color-box" style="background:#6baed6;"></span>21–40%</div>';
        html += '<div><span class="color-box" style="background:#9ecae1;"></span>0–20%</div>';
      } else if (field === 'fin100k') {
        html += '<div><span class="color-box" style="background:#4b0055;"></span>>120</div>';
        html += '<div><span class="color-box" style="background:#7a3290;"></span>91–120</div>';
        html += '<div><span class="color-box" style="background:#985ea7;"></span>61–90</div>';
        html += '<div><span class="color-box" style="background:#b68bc1;"></span>31–60</div>';
        html += '<div><span class="color-box" style="background:#d5b6da;"></span>0–30</div>';
      } else if (field === 'overlap_type') {
        html += '<div><span class="color-box" style="background:#d73027;"></span>Low Screening‑Low Access Cluster</div>';
        html += '<div><span class="color-box" style="background:#6baed6;"></span>High Screening‑High Access Cluster</div>';
        html += '<div><span class="color-box" style="background:#999999;"></span>Non‑significant</div>';
      }
      lc.innerHTML = html;
    }

    function switchField(val) {
      if (currentLayer) { map.removeLayer(currentLayer); }
      const field = val.replace(/_\d+$/, '');
      const pmTiles = val.endsWith('_95') ? pm95 : pm99;
      currentLayer = createLayer(pmTiles, field).addTo(map);
      updateLegend(val);
    }

    $('input[name="tractField"]').change(function() {
      switchField(this.value);
    });

    // Initialize
    switchField('COLON_SCRE_95');

  </script>
</body>
</html>
