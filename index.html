<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catchments & Tracts Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- PMTiles -->
  <script src="https://unpkg.com/pmtiles@3.1.2/dist/umd/index.js"></script>

  <!-- TopoJSON -->
  <script src="https://unpkg.com/topojson-client@3"></script>

  <!-- VectorGrid -->
  <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; }

    .control-panel {
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      border-radius: 4px;
      z-index: 1000;
      max-width: 240px;
    }

    .legend {
      position: absolute;
      bottom: 20px; right: 20px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      border-radius: 4px;
      z-index: 1000;
      max-width: 300px;
    }

    .legend .color-box {
      display: inline-block;
      width: 18px; height: 18px;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="control-panel">
    <strong>95% Hotspot Tracts</strong><br/>
    <label><input type="radio" name="tractField" value="COLON_SCRE_95" checked> CRC screening (%)</label><br/>
    <label><input type="radio" name="tractField" value="fin100k_95"> Primary care providers per 100k</label><br/>
    <label><input type="radio" name="tractField" value="overlap_type_95"> Access-screening overlap</label>

    <hr/>

    <strong>99% Hotspot Tracts</strong><br/>
    <label><input type="radio" name="tractField" value="COLON_SCRE_99"> CRC screening (%)</label><br/>
    <label><input type="radio" name="tractField" value="fin100k_99"> Primary care providers per 100k</label><br/>
    <label><input type="radio" name="tractField" value="overlap_type_99"> Access-screening overlap</label>
  </div>

  <div class="legend">
    <strong>Legend</strong>
    <div id="legend-content"></div>
  </div>

  <script>
    // Access PMTiles constructor from global pmtiles object
    const PMTiles = window.pmtiles?.PMTiles;
    if (!PMTiles) {
      console.error('PMTiles constructor not found.');
    }

    const map = L.map('map').setView([33.5186, -86.8104], 7);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CartoDB'
    }).addTo(map);

    // Load catchments TopoJSON and convert to GeoJSON with only borders (no fill)
    fetch('assets/catchments.json')
      .then(r => r.json())
      .then(topology => {
        const geojson = topojson.feature(topology, topology.objects[Object.keys(topology.objects)[0]]);
        L.geoJSON(geojson, {
          style: { color: '#FF7F00', weight: 2, fillOpacity: 0 },
          onEachFeature: (feature, layer) => {
            if (feature.properties?.name) {
              layer.bindPopup(feature.properties.name);
            }
          }
        }).addTo(map);
      });

    // Initialize PMTiles sources
    const pm95 = new PMTiles('assets/sc_acc_hot_spots_overlap_95.pmtiles');
    const pm99 = new PMTiles('assets/sc_acc_hot_spots_overlap_99.pmtiles');

    let currentLayer;

    function getColor(field, value) {
      if (field === 'COLON_SCRE') {
        if (value > 80) return '#08306b';
        if (value > 60) return '#2171b5';
        if (value > 40) return '#4292c6';
        if (value > 20) return '#6baed6';
        return '#9ecae1';
      }
      if (field === 'fin100k') {
        if (value > 120) return '#4b0055';
        if (value > 90) return '#7a3290';
        if (value > 60) return '#985ea7';
        if (value > 30) return '#b68bc1';
        return '#d5b6da';
      }
      if (field === 'overlap_type') {
        if (value === 'Low Screening-Low Access Cluster') return '#d73027'; // red
        if (value === 'High Screening-High Access Cluster') return '#6baed6'; // light blue
        if (value === 'Non-significant') return '#999999'; // grey
        return '#cccccc';
      }
      return '#cccccc';
    }

    // Create a VectorGrid layer from PMTiles source and chosen field
    function createLayer(pmtilesSource, fieldKey) {
      return L.vectorGrid.protobuf(pmtilesSource.getURLTemplate(), {
        vectorTileLayerStyles: {
          // Assuming vector tile layer name is "layer0"
          layer0: feature => {
            // Extract base field name without trailing _95 or _99
            const baseField = fieldKey.replace(/_\d+$/, '');
            const value = feature.properties[baseField];
            return {
              fillColor: getColor(baseField, value),
              fillOpacity: 0.7,
              color: '#444',
              weight: 0.5
            };
          }
        },
        maxZoom: 14,
        minZoom: 4,
        interactive: true,
        getFeatureId: f => f.properties.id || null
      });
    }

    function updateLegend(fieldKey) {
      const baseField = fieldKey.replace(/_\d+$/, '');
      const legend = document.getElementById('legend-content');
      let html = '';

      if (baseField === 'COLON_SCRE') {
        html += '<div><span class="color-box" style="background:#08306b;"></span>> 80%</div>';
        html += '<div><span class="color-box" style="background:#2171b5;"></span>61–80%</div>';
        html += '<div><span class="color-box" style="background:#4292c6;"></span>41–60%</div>';
        html += '<div><span class="color-box" style="background:#6baed6;"></span>21–40%</div>';
        html += '<div><span class="color-box" style="background:#9ecae1;"></span>0–20%</div>';
      } else if (baseField === 'fin100k') {
        html += '<div><span class="color-box" style="background:#4b0055;"></span>> 120</div>';
        html += '<div><span class="color-box" style="background:#7a3290;"></span>91–120</div>';
        html += '<div><span class="color-box" style="background:#985ea7;"></span>61–90</div>';
        html += '<div><span class="color-box" style="background:#b68bc1;"></span>31–60</div>';
        html += '<div><span class="color-box" style="background:#d5b6da;"></span>0–30</div>';
      } else if (baseField === 'overlap_type') {
        html += '<div><span class="color-box" style="background:#d73027;"></span>Low Screening-Low Access Cluster</div>';
        html += '<div><span class="color-box" style="background:#6baed6;"></span>High Screening-High Access Cluster</div>';
        html += '<div><span class="color-box" style="background:#999999;"></span>Non-significant</div>';
      }

      legend.innerHTML = html;
    }

    function switchLayer(fieldKey) {
      if (currentLayer) {
        map.removeLayer(currentLayer);
        currentLayer = null;
      }

      const pmtilesSource = fieldKey.includes('_95') ? pm95 : pm99;
      currentLayer = createLayer(pmtilesSource, fieldKey).addTo(map);
      updateLegend(fieldKey);
    }

    // Setup radio buttons event listeners
    document.querySelectorAll('input[name="tractField"]').forEach(radio => {
      radio.addEventListener('change', e => {
        if (e.target.checked) {
          switchLayer(e.target.value);
        }
      });
    });

    // Initialize map with default layer
    switchLayer('COLON_SCRE_95');
  </script>
</body>
</html>
